<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>H·ªèi ƒë√°p AI L·ªãch s·ª≠ - History AI EDU</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css">

  <!-- Global style -->
  <link rel="stylesheet" href="css/style.css">

  <!-- Page style -->
  <link rel="stylesheet" href="css/pages/chat-ai.css">

  <!-- App logic -->
  <script type="module" src="js/firebase-config.js"></script>
  <script type="module" src="js/nav.js"></script>
  <script type="module" src="services/guard.js"></script>
  
  <script type="module" src="js/gemini-api.js"></script>
  <script type="module" src="services/history-service.js"></script>
  <script type="module" src="js/chat-ai.js"></script>

</head>

<body class="bg-light">

  <!-- Navbar placeholder -->
  <header id="navbar-root"></header>

  <!-- MAIN CONTENT -->
  <main class="container py-4 chat-page">
    <div class="row g-4">

      <!-- ========== LEFT: KHUNG CHAT HI·ªÜN T·∫†I ========== -->
      <div class="col-lg-8">
        <div class="card chat-card h-100">
          <div class="card-header d-flex flex-column flex-md-row align-items-md-center justify-content-md-between">
            <div class="mb-2 mb-md-0">
              <div class="fw-bold text-primary">H·ªèi ƒë√°p AI L·ªãch s·ª≠</div>
              <div class="small text-muted">
                ƒê·∫∑t c√¢u h·ªèi v·ªÅ s·ª± ki·ªán, nh√¢n v·∫≠t, m·ªëc th·ªùi gian...
              </div>
              <div class="small text-muted d-none d-lg-block mt-1">
                <span class="live-indicator"></span> AI s·∫µn s√†ng
              </div>
            </div>

            <div class="d-flex flex-column flex-sm-row gap-2">
              <button class="btn btn-outline-primary btn-sm fw-semibold" id="btnNewChat">
                + Cu·ªôc h·ªôi tho·∫°i m·ªõi
              </button>
            </div>
          </div>

          <!-- Khung tin nh·∫Øn (ƒë·ªï n·ªôi dung b·∫±ng JS) -->
          <div id="chatMessages" class="card-body chat-messages">
            <!-- tin nh·∫Øn s·∫Ω ƒë∆∞·ª£c render ƒë·ªông ·ªü ƒë√¢y b·∫±ng chat-ai.js -->
            <div class="text-center text-muted small mt-5">
              Ch∆∞a c√≥ tin nh·∫Øn n√†o. H√£y ƒë·∫∑t c√¢u h·ªèi ƒë·∫ßu ti√™n üëá
            </div>
          </div>

          <!-- Form nh·∫≠p c√¢u h·ªèi -->
          <div class="card-footer">
            <form id="askForm" class="ask-form d-flex align-items-start gap-2">
              <textarea
                id="askInput"
                class="form-control ask-input flex-grow-1"
                rows="1"
                placeholder="V√≠ d·ª•: 'Tr·∫≠n B·∫°ch ƒê·∫±ng nƒÉm 1288 di·ªÖn ra nh∆∞ th·∫ø n√†o?'"
                required
              ></textarea>

              <button type="submit" class="btn btn-primary ask-send-btn">
                G·ª≠i
              </button>
            </form>
            <div class="small text-muted mt-2">
              Tr·∫£ l·ªùi c√≥ th·ªÉ ƒë∆∞·ª£c t√≥m l∆∞·ª£c ho·∫∑c di·ªÖn gi·∫£i ƒë·ªÉ d·ªÖ hi·ªÉu h∆°n cho h·ªçc sinh.
            </div>
          </div>
        </div>
      </div>

      <!-- ========== RIGHT: L·ªäCH S·ª¨ CHAT (DANH S√ÅCH CU·ªòC H·ªòI THO·∫†I C≈®) ========== -->
      <div class="col-lg-4">
        <div class="card history-card h-100">
          <div class="card-header">
            <div class="fw-bold">L·ªãch s·ª≠ c√¢u h·ªèi</div>
            <div class="small text-muted">Nh·ªØng c√¢u g·∫ßn ƒë√¢y c·ªßa b·∫°n</div>
          </div>

          <!-- Danh s√°ch l·ªãch s·ª≠ (render ƒë·ªông) -->
          <div id="historyList" class="card-body history-list">
            <div class="text-center text-muted small mt-4 px-2">
              Ch∆∞a c√≥ l·ªãch s·ª≠.
              <br />
              Sau khi b·∫°n h·ªèi AI, c√¢u h·ªèi s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y ƒë·ªÉ m·ªü l·∫°i sau.
            </div>
          </div>

          <div class="card-footer text-center">
            <button class="btn btn-outline-primary btn-sm w-100" id="btnViewAllHistory">
              Xem to√†n b·ªô l·ªãch s·ª≠
            </button>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- Footer placeholder -->
  <footer id="footer-root"></footer>

  <!-- Bootstrap JS (dropdown, collapse, etc.) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Inject navbar + footer -->
  <script type="module">
    import { initNavbarAfterInject } from "./js/nav.js";

    // inject navbar
    fetch('components/navbar.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('navbar-root').innerHTML = html;
        initNavbarAfterInject(); // ch·∫°y auth UI, active link
      });

    // inject footer
    fetch('components/footer.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('footer-root').innerHTML = html;
      });
  </script>

  <!-- G·ª£i √Ω JS t∆∞∆°ng lai (chat-ai.js):
    - btnNewChat.onclick -> clear khung chatMessages + t·∫°o session m·ªõi trong Firestore
    - askForm.submit -> append tin nh·∫Øn user; show loader; g·ªçi Gemini; append tr·∫£ l·ªùi AI; l∆∞u v√†o Firestore
    - load historyList t·ª´ Firestore theo userId; click 1 item -> load l·∫°i session t∆∞∆°ng ·ª©ng
  -->
</body>
</html>
